<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Customer Profitability Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .segment-card { transition: all 0.2s ease-in-out; }
        .segment-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .tab-button.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900 tracking-tight">Relational Segmentation System (RSS) ‚Äì Segmenting customers through relational models</h1>
        <!--<p class="text-lg text-gray-600 mt-2">Graahakon ke data ka vishleshan karein aur unke munafay ko samjhein.</p>-->
        </header>

        <main>
            <!-- Tabs for different sections -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button onclick="switchTab('dashboard')" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Dashboard</button>
                    <button onclick="switchTab('manageData')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Manage Data</button>
                    <button onclick="switchTab('comparison')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Profit/Loss Comparison</button>
                </nav>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <!-- Segment Selection -->
                <section class="mb-10 p-6 bg-white rounded-xl shadow-md">
                    <h2 class="text-2xl font-semibold mb-5 text-gray-800">Select Customer Segment</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Demographic Segments -->
                        <div>
                            <h3 class="font-semibold text-indigo-700 mb-3">üßç Demographic</h3>
                            <div class="space-y-2">
                                <div onclick="updateDashboard('age_18_25', this)" class="segment-card p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-indigo-100">Age: 18-25</div>
                                <div onclick="updateDashboard('age_26_35', this)" class="segment-card p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-indigo-100">Age: 26-35</div>
                                <div onclick="updateDashboard('age_36_50', this)" class="segment-card p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-indigo-100">Age: 36-50</div>
                                <div onclick="updateDashboard('age_50_plus', this)" class="segment-card p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-indigo-100">Age: 50+</div>
                                <div onclick="updateDashboard('gender_male', this)" class="segment-card p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-indigo-100">Gender: Male</div>
                                <div onclick="updateDashboard('gender_female', this)" class="segment-card p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-indigo-100">Gender: Female</div>
                                <div onclick="updateDashboard('income_high', this)" class="segment-card p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-indigo-100">Income: High</div>
                            </div>
                        </div>

                        <!-- Value-Based Segments -->
                        <div>
                            <h3 class="font-semibold text-green-700 mb-3">üí∞ Value-Based</h3>
                            <div class="space-y-2">
                                <div onclick="updateDashboard('high_value', this)" class="segment-card p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-green-100">High-Value (‚Çπ50k+)</div>
                                <div onclick="updateDashboard('medium_value', this)" class="segment-card p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-green-100">Medium-Value (‚Çπ20k-‚Çπ50k)</div>
                                <div onclick="updateDashboard('low_value', this)" class="segment-card p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-green-100">Low-Value (&lt;‚Çπ20k)</div>
                            </div>
                        </div>

                        <!-- Loyalty Segments -->
                        <div>
                            <h3 class="font-semibold text-blue-700 mb-3">üíé Loyalty</h3>
                             <div class="space-y-2">
                                <div onclick="updateDashboard('new_customers', this)" class="segment-card p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-blue-100">New (Last 30 days)</div>
                                <div onclick="updateDashboard('returning_customers', this)" class="segment-card p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-blue-100">Returning (2-10 orders)</div>
                                <div onclick="updateDashboard('at_risk', this)" class="segment-card p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-blue-100">At-Risk (No purchase > 90d)</div>
                            </div>
                        </div>

                        <!-- Custom Segment -->
                        <div>
                            <h3 class="font-semibold text-purple-700 mb-3">üéØ Custom SQL Segment</h3>
                            <div class="bg-gray-100 p-4 rounded-lg">
                                <textarea id="custom-sql-filter" class="w-full p-2 border border-gray-300 rounded-md text-sm" rows="3" placeholder="e.g., c.age < 30 AND c.income_level = 'High'"></textarea>
                                <button onclick="applyCustomFilter()" class="mt-2 w-full bg-purple-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-purple-700">Apply Filter</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Analytics Display -->
                <section id="analytics-section" class="hidden">
                    <h2 class="text-2xl font-semibold mb-5" id="analytics-title">Segment Analysis</h2>
                    
                    <!-- Key Metrics -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6 text-center">
                        <div class="p-4 bg-white rounded-xl shadow"><p class="text-sm text-gray-500">Total Customers</p><p id="total-customers" class="text-2xl font-bold">0</p></div>
                        <div class="p-4 bg-white rounded-xl shadow"><p class="text-sm text-gray-500">Total Revenue</p><p id="total-revenue" class="text-2xl font-bold">‚Çπ0</p></div>
                        <div class="p-4 bg-white rounded-xl shadow"><p class="text-sm text-gray-500">Total Profit</p><p id="total-profit" class="text-2xl font-bold text-green-600">‚Çπ0</p></div>
                        <div class="p-4 bg-white rounded-xl shadow"><p class="text-sm text-gray-500">Avg. Revenue</p><p id="avg-revenue" class="text-2xl font-bold">‚Çπ0</p></div>
                         <div class="p-4 bg-white rounded-xl shadow"><p class="text-sm text-gray-500">Total Purchases</p><p id="total-purchases" class="text-2xl font-bold">0</p></div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="p-6 bg-white rounded-xl shadow">
                            <h3 class="font-semibold mb-4">Profit by Customer</h3>
                            <canvas id="profit-chart"></canvas>
                        </div>
                        <div class="p-6 bg-white rounded-xl shadow">
                            <h3 class="font-semibold mb-4">Age Distribution</h3>
                            <canvas id="age-chart"></canvas>
                        </div>
                    </div>

                    <!-- Data Table -->
                     <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="text-xl font-semibold mb-4">Customer Details</h3>
                        <div id="loader" class="hidden my-8 mx-auto loader"></div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Revenue</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Profit</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purchases</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Purchase</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="customer-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Manage Data Tab -->
            <div id="manageData" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Top Row -->
                    <div class="p-6 bg-white rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Upload Customer Data</h2>
                        <form id="uploadForm" class="space-y-4">
                            <div>
                                <label for="file-upload" class="block text-sm font-medium text-gray-700">Upload Excel or CSV File</label>
                                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                    <div class="space-y-1 text-center">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                        <div class="flex text-sm text-gray-600"><label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500"><span>Upload a file</span><input id="file-upload" name="file" type="file" class="sr-only" accept=".csv, .xlsx"></label><p class="pl-1">or drag and drop</p></div>
                                        <p class="text-xs text-gray-500">CSV, XLSX up to 10MB</p>
                                    </div>
                                </div>
                                <p id="file-name" class="mt-2 text-sm text-gray-500"></p>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Upload and Process</button>
                        </form>
                        <div id="upload-status" class="mt-4"></div>
                    </div>
                    <div class="p-6 bg-white rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Add New Customer</h2>
                        <form id="addCustomerForm" class="space-y-4">
                            <div>
                                <label for="customer_name" class="block text-sm font-medium">Name</label>
                                <input type="text" id="customer_name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="customer_age" class="block text-sm font-medium">Age</label>
                                    <input type="number" id="customer_age" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                                </div>
                                <div>
                                    <label for="customer_gender" class="block text-sm font-medium">Gender</label>
                                    <select id="customer_gender" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                        <option>Male</option><option>Female</option><option>Other</option>
                                    </select>
                                </div>
                            </div>
                             <div>
                                <label for="customer_region" class="block text-sm font-medium">Region</label>
                                <input type="text" id="customer_region" placeholder="e.g., Mumbai" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                            </div>
                            <div>
                                <label for="customer_income" class="block text-sm font-medium">Income Level</label>
                                <select id="customer_income" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option>Low</option><option>Medium</option><option>High</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">Add Customer</button>
                        </form>
                        <div id="customer-status" class="mt-4"></div>
                    </div>
                    <!-- Bottom Row -->
                    <div class="p-6 bg-white rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Add New Transaction</h2>
                        <form id="addTransactionForm" class="space-y-4">
                            <div>
                                <label for="customer_id" class="block text-sm font-medium">Customer ID</label>
                                <input type="number" id="customer_id" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="amount" class="block text-sm font-medium">Amount (‚Çπ)</label>
                                    <input type="number" id="amount" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                                </div>
                                <div>
                                    <label for="cost_of_goods" class="block text-sm font-medium">Cost of Goods (‚Çπ)</label>
                                    <input type="number" id="cost_of_goods" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                                </div>
                            </div>
                            <div>
                                <label for="product_category" class="block text-sm font-medium">Product Category</label>
                                <input type="text" id="product_category" placeholder="e.g., Electronics" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                            </div>
                            <div>
                                <label for="payment_method" class="block text-sm font-medium">Payment Method</label>
                                <select id="payment_method" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option>Credit Card</option><option>UPI</option><option>Net Banking</option><option>Cash</option>
                                </select>
                            </div>
                            <div class="flex items-center">
                                <input id="discount_used" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                <label for="discount_used" class="ml-2 block text-sm">Discount Used?</label>
                            </div>
                            <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">Add Transaction</button>
                        </form>
                        <div id="transaction-status" class="mt-4"></div>
                    </div>
                     <div class="p-6 bg-white rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Remove Customer</h2>
                        <form id="removeCustomerForm" class="space-y-4">
                            <div>
                                <label for="remove_customer_id" class="block text-sm font-medium">Customer ID to Remove</label>
                                <input type="number" id="remove_customer_id" placeholder="Enter Customer ID" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                            </div>
                            <button type="submit" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700">Remove Customer</button>
                        </form>
                        <div id="remove-status" class="mt-4"></div>
                    </div>
                </div>
            </div>

            <!-- Profit/Loss Comparison Tab -->
            <div id="comparison" class="tab-content hidden">
                <div class="p-6 bg-white rounded-xl shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Monthly Profit & Loss Comparison</h2>
                    <div class="flex items-end space-x-4 mb-6 bg-gray-50 p-4 rounded-lg">
                        <div>
                            <label for="start-month" class="block text-sm font-medium text-gray-700">Start Month</label>
                            <input type="month" id="start-month" class="mt-1 p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="end-month" class="block text-sm font-medium text-gray-700">End Month</label>
                            <input type="month" id="end-month" class="mt-1 p-2 border border-gray-300 rounded-md">
                        </div>
                        <button onclick="fetchComparisonData()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Compare</button>
                    </div>
                    <div id="comparison-loader" class="hidden my-8 mx-auto loader"></div>
                    <canvas id="comparison-chart" class="hidden"></canvas>
                </div>
            </div>

        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000';
        let profitChart, ageChart, comparisonChart;

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabName).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }

        async function fetchSegmentData(segmentId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/segment/${segmentId}`);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                return await response.json();
            } catch (error) {
                console.error(`Segment ${segmentId} not fetch `, error);
                alert(`Error: Could not fetch data for segment ${segmentId}. Is the server running?`);
                return [];
            }
        }

        async function updateDashboard(segmentId, element) {
            const analyticsSection = document.getElementById('analytics-section');
            const loader = document.getElementById('loader');
            
            document.querySelectorAll('.segment-card').forEach(card => card.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-100'));
            if (element) {
                element.classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-100');
            }

            analyticsSection.classList.remove('hidden');
            document.getElementById('analytics-title').textContent = `Analysis for: ${element ? element.textContent : 'Custom Segment'}`;
            loader.classList.remove('hidden');
            document.getElementById('customer-table-body').innerHTML = '';

            const data = await fetchSegmentData(segmentId);
            loader.classList.add('hidden');
            
            populateMetrics(data);
            populateTable(data);
            createCharts(data);
        }

        function populateMetrics(data) {
            const totalCustomers = data.length;
            const totalRevenue = data.reduce((sum, c) => sum + (parseFloat(c.total_revenue) || 0), 0);
            const totalProfit = data.reduce((sum, c) => sum + (parseFloat(c.total_profit) || 0), 0);
            const totalPurchases = data.reduce((sum, c) => sum + (c.purchase_count || 0), 0);

            document.getElementById('total-customers').textContent = totalCustomers;
            document.getElementById('total-revenue').textContent = `‚Çπ${totalRevenue.toLocaleString('en-IN')}`;
            document.getElementById('total-profit').textContent = `‚Çπ${totalProfit.toLocaleString('en-IN')}`;
            document.getElementById('avg-revenue').textContent = totalCustomers > 0 ? `‚Çπ${(totalRevenue / totalCustomers).toLocaleString('en-IN', {maximumFractionDigits: 0})}` : '‚Çπ0';
            document.getElementById('total-purchases').textContent = totalPurchases;
        }

        function populateTable(data) {
            const tableBody = document.getElementById('customer-table-body');
            tableBody.innerHTML = ''; // Clear existing rows
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4">Is segment mein koi customer nahi mila.</td></tr>';
                return;
            }

            data.forEach(customer => {
                const profitClass = (customer.total_profit || 0) >= 0 ? 'text-green-600' : 'text-red-600';
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">${customer.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${customer.age || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${customer.gender || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">‚Çπ${(customer.total_revenue || 0).toLocaleString('en-IN')}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-semibold ${profitClass}">‚Çπ${(customer.total_profit || 0).toLocaleString('en-IN')}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${customer.purchase_count || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${customer.last_purchase_date || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="deleteCustomer(${customer.id}, this)" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
        
        async function deleteCustomer(customerId, element) {
            if (!confirm(`you want to  ${customerId} delete `)) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/customers/${customerId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Deletion failed');
                const result = await response.json();
                if (result.success) {
                    if(element) element.closest('tr').remove();
                    alert('Customer successfully deleted.');
                } else {
                    alert('Error: Could not delete customer. ' + (result.message || ''));
                }
            } catch (error) {
                console.error("Delete customer error:", error);
                alert('An error occurred while deleting the customer.');
            }
        }

        function createCharts(data) {
            if (profitChart) profitChart.destroy();
            if (ageChart) ageChart.destroy();

            // Profit Chart
            const profitCtx = document.getElementById('profit-chart').getContext('2d');
            const sortedByProfit = [...data].sort((a, b) => (b.total_profit || 0) - (a.total_profit || 0)).slice(0, 10);
            profitChart = new Chart(profitCtx, {
                type: 'bar',
                data: {
                    labels: sortedByProfit.map(c => c.name),
                    datasets: [{
                        label: 'Total Profit (‚Çπ)',
                        data: sortedByProfit.map(c => c.total_profit || 0),
                        backgroundColor: sortedByProfit.map(c => (c.total_profit || 0) >= 0 ? 'rgba(22, 163, 74, 0.6)' : 'rgba(220, 38, 38, 0.6)'),
                        borderColor: sortedByProfit.map(c => (c.total_profit || 0) >= 0 ? 'rgba(22, 163, 74, 1)' : 'rgba(220, 38, 38, 1)'),
                        borderWidth: 1
                    }]
                },
                options: { responsive: true }
            });

            // Age Distribution Chart
            const ageCtx = document.getElementById('age-chart').getContext('2d');
            const ageGroups = { '18-25': 0, '26-35': 0, '36-50': 0, '50+': 0, 'N/A': 0 };
            data.forEach(c => {
                if (c.age >= 18 && c.age <= 25) ageGroups['18-25']++;
                else if (c.age >= 26 && c.age <= 35) ageGroups['26-35']++;
                else if (c.age >= 36 && c.age <= 50) ageGroups['36-50']++;
                else if (c.age > 50) ageGroups['50+']++;
                else ageGroups['N/A']++;
            });
            ageChart = new Chart(ageCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(ageGroups),
                    datasets: [{
                        data: Object.values(ageGroups),
                        backgroundColor: ['#6366F1', '#818CF8', '#A5B4FC', '#C7D2FE', '#E0E7FF']
                    }]
                },
                options: { responsive: true, cutout: '50%' }
            });
        }
        
        async function applyCustomFilter() {
            const filter = document.getElementById('custom-sql-filter').value;
            if (!filter.trim()) {
                alert('Please enter a SQL filter condition.');
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/api/segment/custom`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filter: filter })
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Custom filter failed');
                }
                const data = await response.json();
                document.querySelectorAll('.segment-card').forEach(card => card.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-100'));
                const analyticsSection = document.getElementById('analytics-section');
                analyticsSection.classList.remove('hidden');
                document.getElementById('analytics-title').textContent = `Analysis for: Custom SQL Filter`;
                populateMetrics(data);
                populateTable(data);
                createCharts(data);
            } catch (error) {
                console.error("Custom filter error:", error);
                alert(`Error: ${error.message}`);
            }
        }

        async function fetchComparisonData() {
            const startMonth = document.getElementById('start-month').value;
            const endMonth = document.getElementById('end-month').value;
            if (!startMonth || !endMonth) {
                alert('Please select both start and end months.');
                return;
            }
            const loader = document.getElementById('comparison-loader');
            const chartCanvas = document.getElementById('comparison-chart');
            loader.classList.remove('hidden');
            chartCanvas.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE_URL}/api/comparison?start=${startMonth}&end=${endMonth}`);
                if (!response.ok) throw new Error('Failed to fetch comparison data.');
                const data = await response.json();
                
                loader.classList.add('hidden');
                chartCanvas.classList.remove('hidden');

                if (comparisonChart) comparisonChart.destroy();
                const ctx = chartCanvas.getContext('2d');
                comparisonChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.month),
                        datasets: [
                            {
                                label: 'Total Revenue (‚Çπ)',
                                data: data.map(d => d.total_revenue),
                                borderColor: '#4f46e5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                tension: 0.1,
                                fill: true,
                            },
                            {
                                label: 'Total Profit (‚Çπ)',
                                data: data.map(d => d.total_profit),
                                borderColor: '#16a34a',
                                backgroundColor: 'rgba(22, 163, 74, 0.1)',
                                tension: 0.1,
                                fill: true,
                            }
                        ]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            } catch (error) {
                loader.classList.add('hidden');
                console.error("Comparison data error:", error);
                alert('Error fetching comparison data.');
            }
        }
        
        // --- Event Listeners for Forms ---
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file to upload.');
                return;
            }
            const formData = new FormData();
            formData.append('file', file);

            const statusDiv = document.getElementById('upload-status');
            statusDiv.innerHTML = '<div class="loader mx-auto"></div>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/upload`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    statusDiv.innerHTML = `<p class="text-green-600">${result.message}</p>`;
                } else {
                    statusDiv.innerHTML = `<p class="text-red-600">Error: ${result.error}</p>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p class="text-red-600">An unexpected error occurred.</p>`;
                console.error('File upload error:', error);
            }
        });

        document.getElementById('file-upload').addEventListener('change', function() {
            const fileName = this.files[0] ? this.files[0].name : 'No file chosen';
            document.getElementById('file-name').textContent = fileName;
        });
        
        document.getElementById('addCustomerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const customerData = {
                name: document.getElementById('customer_name').value,
                age: document.getElementById('customer_age').value,
                gender: document.getElementById('customer_gender').value,
                region: document.getElementById('customer_region').value,
                income_level: document.getElementById('customer_income').value,
            };
            const statusDiv = document.getElementById('customer-status');
            statusDiv.innerHTML = '';
            try {
                const response = await fetch(`${API_BASE_URL}/api/customers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(customerData)
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    statusDiv.innerHTML = `<p class="text-green-600">Customer added successfully with ID: ${result.id}</p>`;
                    this.reset();
                } else {
                    statusDiv.innerHTML = `<p class="text-red-600">Error: ${result.error}</p>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p class="text-red-600">An unexpected error occurred.</p>`;
                console.error('Add customer error:', error);
            }
        });

        document.getElementById('addTransactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const transactionData = {
                customer_id: document.getElementById('customer_id').value,
                amount: document.getElementById('amount').value,
                cost_of_goods: document.getElementById('cost_of_goods').value,
                product_category: document.getElementById('product_category').value,
                payment_method: document.getElementById('payment_method').value,
                discount_used: document.getElementById('discount_used').checked,
            };
            const statusDiv = document.getElementById('transaction-status');
            statusDiv.innerHTML = '';
            try {
                const response = await fetch(`${API_BASE_URL}/api/transactions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transactionData)
                });
                const result = await response.json();
                if (response.ok && result.success) {
                    statusDiv.innerHTML = `<p class="text-green-600">Transaction added successfully with ID: ${result.id}</p>`;
                    this.reset();
                } else {
                    statusDiv.innerHTML = `<p class="text-red-600">Error: ${result.error}</p>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p class="text-red-600">An unexpected error occurred.</p>`;
                console.error('Add transaction error:', error);
            }
        });

        document.getElementById('removeCustomerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const customerId = document.getElementById('remove_customer_id').value;
            if(!customerId) {
                alert('Please enter a Customer ID.');
                return;
            }
            const statusDiv = document.getElementById('remove-status');
            statusDiv.innerHTML = '';
            
            if (!confirm(`you want to ${customerId}  delete `)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/customers/${customerId}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (response.ok && result.success) {
                    statusDiv.innerHTML = `<p class="text-green-600">Customer ID ${customerId} successfully deleted.</p>`;
                    this.reset();
                } else {
                    statusDiv.innerHTML = `<p class="text-red-600">Error: Could not delete customer. ${result.message || ''}</p>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p class="text-red-600">An unexpected error occurred.</p>`;
                console.error('Remove customer error:', error);
            }
        });

        // Initial setup
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth() - 5, 1);
        document.getElementById('end-month').value = now.toISOString().slice(0, 7);
        document.getElementById('start-month').value = firstDay.toISOString().slice(0, 7);
        
    </script>
</body>
</html>

